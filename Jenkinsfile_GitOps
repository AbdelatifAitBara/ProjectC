pipeline {
    agent {
        label 'Building_Machine'
    }

    environment {
        MICROSERVICES_DIR = '/home/ubuntu/ProjectC-GitOps/microservices'
    }   

    parameters {
        string(name: 'COMMIT', defaultValue: env.GIT_COMMIT, description: 'Docker Image Tag')
    }



    stages {


        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }
        stage('Checkout GitOps Repo') {
            steps {
                sh "git clone --recursive git@github.com:AbdelatifAitBara/ProjectC-GitOps.git"
            }
        }

        stage('Replace Image Tag') {
            steps {
                sh "sed -i 's/abdelatifaitbara\/customer:${GIT_COMMIT}/abdelatifaitbara\/customer:${COMMIT}/g' ${MICROSERVICES_DIR}/customer.yaml"
            }
        }

        stage('Commit Changes') {
            steps {
                sh "git add ."
                sh "git commit -m 'Updated Images Tags'"
            }
        }

        stage('Push to GitOps Repo') {
            steps {
                sh "git push origin main"
            }
        }
    }

    post {
        success {
        slackSend(color: '#32CD32', message: "Deployment updated with image ${parameters.COMMIT}")
        }
    }
}