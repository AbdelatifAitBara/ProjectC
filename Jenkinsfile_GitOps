pipeline {
    agent {
        label 'Building_Machine'
    }

    environment {
        WORKSPACE = '/home/ubuntu/'
        PROJECT_DIR = '/home/ubuntu/ProjectC-GitOps'
        MICROSERVICES_DIR = '/home/ubuntu/ProjectC-GitOps/microservices'

    }   

    parameters {
        string(name: 'COMMIT', defaultValue: env.GIT_COMMIT, description: 'Docker Image Tag')
    }



    stages {


        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }

        
        stage('Clone Git Repository') {
            steps {
                sh "rm -rf ${PROJECT_DIR}"
                sh "git -C ${WORKSPACE} clone -b main --recursive git@github.com:AbdelatifAitBara/ProjectC-GitOps.git"
            }
        }

        stage('Replace Image Tag') {
            steps {
                sh "sed -i 's/abdelatifaitbara\\/customer:${GIT_COMMIT}/abdelatifaitbara\\/customer:${COMMIT}/g' ${MICROSERVICES_DIR}/customer.yaml"
            }
        }

        stage('Commit Changes') {
            steps {
                dir("${PROJECT_DIR}") {
                    sh "git add ."
                    sh "git commit -m 'Update Image Tag --global'"
                }
            }
        }

        stage('Push to GitOps Repo') {
            steps {
                sh "git push origin main"
            }
        }
    }

    post {
        success {
        slackSend(color: '#32CD32', message: "Deployment updated with image ${parameters.COMMIT}")
        }
    }
}